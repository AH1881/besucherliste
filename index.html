<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Besucherliste - Aust & Hachmann oHG</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            min-height: 100vh;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 3px solid #1a5c38;
        }

        .logo {
            max-width: 364px;
            height: auto;
            margin-bottom: 5px;
        }

        .header h1 {
            color: #1a5c38;
            margin: 10px 0 0 0;
            font-size: 30px;
            font-weight: 600;
        }

        /* ============================================
           START SCREEN
           ============================================ */
        .start-screen {
            padding: 60px 30px;
            text-align: center;
        }

        .start-screen.hidden {
            display: none;
        }

        .start-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .start-btn {
            padding: 30px 50px;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
        }

        .start-btn-anmeldung {
            background: #1a5c38;
            color: white;
        }

        .start-btn-anmeldung:hover {
            background: #145230;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(26,92,56,0.3);
        }

        .start-btn-abmeldung {
            background: #c0392b;
            color: white;
        }

        .start-btn-abmeldung:hover {
            background: #a33225;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(192,57,43,0.3);
        }

        .start-btn-icon {
            display: block;
            font-size: 36px;
            margin-bottom: 10px;
        }

        /* ============================================
           MAIN CONTENT (hidden until button clicked)
           ============================================ */
        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            background: #e9ecef;
            color: #666;
        }

        .tab:first-child:hover {
            background: #28a745;
            color: white;
        }

        .tab:last-child:hover {
            background: #dc3545;
            color: white;
        }

        .tab:first-child.active {
            background: #1a5c38;
            color: white;
        }

        .tab:last-child.active {
            background: #c0392b;
            color: white;
        }

        .tab-icon {
            display: block;
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* Content */
        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Rules */
        .rules {
            background: #e8f5e9;
            border-left: 4px solid #1a5c38;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 12px;
            line-height: 1.5;
            border-radius: 0 8px 8px 0;
        }

        .rules h3 {
            margin: 0 0 10px 0;
            font-size: 13px;
            color: #1a5c38;
            font-weight: 700;
        }

        .rules ul {
            margin: 0;
            padding-left: 18px;
            color: #2e7d32;
            font-weight: 600;
        }

        .rules li {
            margin-bottom: 4px;
        }

        /* ============================================
           FORM GRID - Layout personalizado
           ============================================ */
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        /* Primera fila: Name y Firma iguales (50% cada uno) */
        .form-row-1 .form-group {
            flex: 1;
        }

        /* Segunda fila: alineado al centro */
        .form-row-2 {
            justify-content: center;
        }

        .form-row-2 .form-group {
            flex: 0 0 auto;
        }

        .form-row-2 label {
            font-weight: 700;
            font-size: 14px;
            text-align: center;
        }

        input[type="text"],
        input[type="date"] {
            padding: 8px 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            height: 38px;
            width: 100%;
        }

        #eingangDate {
            width: 115px;
            text-align: center;
            font-weight: 700;
        }

        #eingangTime {
            width: 90px;
            text-align: center;
            font-weight: 700;
        }

        #nr {
            width: 90px;
            text-align: center;
            font-weight: 700;
        }

        input:focus {
            outline: none;
            border-color: #1a5c38;
        }

        input[readonly] {
            background: #f5f5f5;
            color: #333;
        }



        .btn-ausgang {
            background: #c0392b;
            color: white;
            padding: 0 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            height: 48px;
        }

        .btn-ausgang:hover {
            background: #a33225;
        }

        .btn-ausgang:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Signature */
        .signature-section {
            margin-bottom: 20px;
        }

        .signature-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        #signatureCanvas {
            width: 100%;
            height: 180px;
            cursor: crosshair;
            touch-action: none;
            display: block;
        }

        .signature-actions {
            padding: 10px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
        }

        .btn-clear {
            padding: 8px 16px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-clear:hover {
            background: #7f8c8d;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #e8f5e9;
            border-left: 4px solid #1a5c38;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .checkbox-group label {
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            margin-bottom: 0;
        }

        /* Buttons */
        .submit-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .btn-back-inline {
            padding: 15px 30px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-back-inline:hover {
            background: #5a6268;
        }

        .btn-submit {
            padding: 15px 50px;
            background: #1a5c38;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-submit:hover {
            background: #145230;
            transform: translateY(-2px);
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-confirm {
            padding: 15px 50px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-confirm:hover {
            background: #a33225;
        }

        .btn-confirm:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Back button */
        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 20px;
        }

        .btn-back:hover {
            background: #5a6268;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-icon {
            font-size: 50px;
            margin-bottom: 15px;
            color: #1a5c38;
        }

        .modal h2 {
            color: #1a5c38;
            margin: 0 0 20px 0;
            font-size: 20px;
        }

        .modal-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: left;
        }

        .modal-info p {
            margin: 5px 0;
            font-size: 15px;
        }

        .modal-info strong {
            color: #1a5c38;
        }

        .modal-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-bottom: 20px;
            text-align: left;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            color: #856404;
        }

        .modal-footer {
            color: #666;
            font-size: 13px;
            margin-top: 15px;
        }

        .modal-footer strong {
            color: #1a5c38;
        }

        .btn-modal-close {
            padding: 12px 40px;
            background: #1a5c38;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-modal-close:hover {
            background: #145230;
        }

        /* Messages */
        .message {
            display: none;
            padding: 15px 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Abmeldung Tab */
        .pending-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .pending-header h3 {
            margin: 0;
            color: #333;
        }

        .btn-refresh {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-refresh:hover {
            background: #5a6268;
        }

        .visitor-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .visitor-card:hover {
            border-color: #1a5c38;
            background: #f8f9fa;
        }

        .visitor-card.selected {
            border-color: #1a5c38;
            background: #f0f7f4;
        }

        .visitor-card-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .visitor-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .visitor-nr {
            background: #1a5c38;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            width: fit-content;
            margin-bottom: 4px;
        }

        .visitor-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            line-height: 1.6;
        }

        .visitor-firma {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .visitor-right {
            text-align: right;
            font-size: 14px;
            color: #666;
        }

        .visitor-eingang-badge {
            background: #1a5c38;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            margin-bottom: 4px;
        }

        .visitor-right .datum-uhr {
            color: #666;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .visitor-right .datum-uhr strong {
            color: #333;
        }

        .visitor-right .datum-uhr span {
            line-height: 1.6;
        }

        .no-visitors {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .selected-visitor-details {
            display: none;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #eee;
        }

        .selected-visitor-details.active {
            display: block;
        }

        .detail-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .detail-item {
            flex: 1;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 6px;
            height: 48px;
            display: flex;
            align-items: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a5c38;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .start-screen {
                padding: 40px 20px;
            }

            .start-buttons {
                flex-direction: column;
            }

            .start-btn {
                width: 100%;
                min-width: auto;
            }

            .tab-content {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .time-wrapper {
                grid-template-columns: 1fr 80px;
            }

            .detail-row {
                flex-direction: column;
            }

            .logo {
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="../Logo.png" alt="Aust & Hachmann" class="logo">
            <h1>BESUCHERLISTE</h1>
        </div>

        <!-- ============================================
             START SCREEN - 2 buttons only
             ============================================ -->
        <div class="start-screen" id="startScreen">
            <div class="start-buttons">
                <button class="start-btn start-btn-anmeldung" onclick="openAnmeldung()">
                    <span class="start-btn-icon">→</span>
                    Anmeldung
                </button>
                <button class="start-btn start-btn-abmeldung" onclick="openAbmeldung()">
                    <span class="start-btn-icon">←</span>
                    Abmeldung
                </button>
            </div>
        </div>

        <!-- ============================================
             MAIN CONTENT - Hidden until button clicked
             ============================================ -->
        <div class="main-content" id="mainContent">
            <div class="tabs">
                <button class="tab active" id="tabAnmeldung" onclick="showTab('anmeldung')">
                    <span class="tab-icon">→</span>
                    Anmeldung
                </button>
                <button class="tab" id="tabAbmeldung" onclick="showTab('abmeldung')">
                    <span class="tab-icon">←</span>
                    Abmeldung
                </button>
            </div>

            <!-- ANMELDUNG TAB -->
            <div id="anmeldung" class="tab-content active">

                <form id="anmeldungForm">

                    <!-- Fila 1: Name + Firma -->
                    <div class="form-row form-row-1">
                        <div class="form-group">
                            <label for="name">Name</label>
                            <input type="text" id="name" name="name" required placeholder="Vor- und Nachname" oninput="validateForm()">
                        </div>
                        <div class="form-group">
                            <label for="firma">Firma</label>
                            <input type="text" id="firma" name="firma" placeholder="Name der Firma">
                        </div>
                    </div>

                    <!-- Fila 2: Besucher Nr. + Datum + Eingang Uhr (centrados) -->
                    <div class="form-row form-row-2">
                        <div class="form-group">
                            <label for="nr">Besucher Nr.</label>
                            <input type="text" id="nr" name="nr" required placeholder="00" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,''); validateForm();" onblur="if(this.value.length===1)this.value='0'+this.value">
                        </div>
                        <div class="form-group">
                            <label for="eingangDate">Datum</label>
                            <input type="text" id="eingangDate" name="eingangDate" readonly>
                        </div>
                        <div class="form-group">
                            <label for="eingangTime">Eingang Uhr</label>
                            <input type="text" id="eingangTime" name="eingangTime" readonly>
                        </div>
                    </div>

                    <!-- Unterschrift -->
                    <div class="signature-section">
                        <label style="font-weight: 600; color: #333; font-size: 13px; display: block; margin-bottom: 5px;">Unterschrift</label>
                        <div class="signature-container">
                            <canvas id="signatureCanvas"></canvas>
                            <div class="signature-actions">
                                <button type="button" class="btn-clear" onclick="clearSignature()">Löschen</button>
                            </div>
                        </div>
                    </div>

                    <!-- Hinweise für Besucher -->
                    <div class="rules">
                        <h3>Hinweise für Besucher:</h3>
                        <ul>
                            <li>Die Anfertigung von Bild- oder Filmaufnahmen ist in allen Betriebsräumlichkeiten verboten sofern keine Berechtigung vorliegt.</li>
                            <li>Flucht- und Rettungspläne sowie Gebots-, Verbots- und Hinweisschilder sind zu beachten.</li>
                            <li>Das Betreten von Produktionsbereichen ist nur in Begleitung eines Mitarbeiters und nach Anlegen angemessener Schutzkleidung gestattet.</li>
                            <li>Es gilt ein Rauchverbot im gesamten Betrieb.</li>
                        </ul>
                    </div>

                    <!-- Checkbox -->
                    <div class="checkbox-group">
                        <input type="checkbox" id="bestaetigung" name="bestaetigung" required onchange="validateForm()">
                        <label for="bestaetigung">Ich bestätige, dass ich die oben genannten Regeln gelesen und verstanden habe.</label>
                    </div>

                    <!-- Submit + Zurück -->
                    <div class="submit-section">
                        <button type="submit" class="btn-submit" id="submitBtn" disabled>Anmeldung speichern</button>
                        <button type="button" class="btn-back-inline" onclick="goBack()">← Zurück</button>
                    </div>

                    <div class="message error" id="errorMessage">
                        ✗ Fehler beim Speichern. Bitte versuchen Sie es erneut.
                    </div>
                </form>
            </div>

            <!-- ABMELDUNG TAB -->
            <div id="abmeldung" class="tab-content">

                <div class="pending-header">
                    <h3>Besucher auswählen:</h3>
                    <button class="btn-refresh" onclick="loadPendingVisitors()">↻ Aktualisieren</button>
                </div>

                <div id="pendingVisitorsContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        Laden...
                    </div>
                </div>

                <div class="selected-visitor-details" id="selectedVisitorDetails">

                    <!-- Submit + Zurück -->
                    <div class="submit-section">
                        <button type="button" class="btn-confirm" id="confirmBtn" onclick="confirmAbmeldung()">Abmeldung</button>
                        <button type="button" class="btn-back-inline" onclick="goBack()">← Zurück</button>
                    </div>

                    <div class="message error" id="abmeldungError">
                        ✗ Fehler beim Speichern.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación Anmeldung -->
    <div class="modal-overlay" id="successModal">
        <div class="modal">
            <h2>Anmeldung erfolgreich!</h2>

            <div class="modal-info" style="text-align: center;">
                <p style="font-size: 18px;">Besucher Nr.: <span id="modalNr" style="font-weight: 700;"></span></p>
                <p style="font-size: 18px;">Eingang Uhr: <span id="modalTime" style="font-weight: 700;"></span></p>
            </div>

            <div class="modal-warning">
                Bitte vergessen Sie nicht, sich später abzumelden. Vielen Dank!
            </div>

            <button class="btn-modal-close" onclick="closeModal()">Verstanden</button>

            <div class="modal-footer">
                <strong>Aust & Hachmann Team</strong>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación Abmeldung -->
    <div class="modal-overlay" id="abmeldungModal">
        <div class="modal">
            <h2 style="color: #c0392b;">Abmeldung erfolgreich!</h2>

            <div class="modal-info" style="text-align: center;">
                <p style="font-size: 18px;">Besucher Nr.: <span id="modalAbmeldungNr" style="font-weight: 700;"></span></p>
                <p style="font-size: 18px;">Ausgang Uhr: <span id="modalAbmeldungTime" style="font-weight: 700;"></span></p>
            </div>

            <div class="modal-warning" style="background: #d4edda; border-left-color: #28a745; color: #155724; text-align: center;">
                Vielen Dank für Ihren Besuch!
            </div>

            <button class="btn-modal-close" style="background: #c0392b;" onclick="closeAbmeldungModal()">Verstanden</button>

            <div class="modal-footer">
                <strong>Aust & Hachmann Team</strong>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyFFgFw6tfTC4ElgfE8GMpdUeXocOiSprZR0RDpiXlehNJtwvPU9AFVdNv9nLx9I24MpA/exec'
        let selectedVisitor = null;
        let pendingVisitors = [];

        // ============================================
        // PERFORMANCE UTILITIES
        // ============================================
        function debounce(fn, delay) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // Debounced form validation (defined after validateForm exists)
        let debouncedValidateForm;

        // ============================================
        // CACHED DOM REFERENCES
        // ============================================
        const elements = {};

        function cacheElements() {
            elements.startScreen = document.getElementById('startScreen');
            elements.mainContent = document.getElementById('mainContent');
            elements.tabAnmeldung = document.getElementById('tabAnmeldung');
            elements.tabAbmeldung = document.getElementById('tabAbmeldung');
            elements.anmeldung = document.getElementById('anmeldung');
            elements.abmeldung = document.getElementById('abmeldung');
            elements.anmeldungForm = document.getElementById('anmeldungForm');
            elements.name = document.getElementById('name');
            elements.firma = document.getElementById('firma');
            elements.nr = document.getElementById('nr');
            elements.eingangDate = document.getElementById('eingangDate');
            elements.eingangTime = document.getElementById('eingangTime');
            elements.bestaetigung = document.getElementById('bestaetigung');
            elements.submitBtn = document.getElementById('submitBtn');
            elements.confirmBtn = document.getElementById('confirmBtn');
            elements.signatureCanvas = document.getElementById('signatureCanvas');
            elements.errorMessage = document.getElementById('errorMessage');
            elements.abmeldungError = document.getElementById('abmeldungError');
            elements.pendingVisitorsContainer = document.getElementById('pendingVisitorsContainer');
            elements.selectedVisitorDetails = document.getElementById('selectedVisitorDetails');
            elements.successModal = document.getElementById('successModal');
            elements.abmeldungModal = document.getElementById('abmeldungModal');
            elements.modalNr = document.getElementById('modalNr');
            elements.modalTime = document.getElementById('modalTime');
            elements.modalAbmeldungNr = document.getElementById('modalAbmeldungNr');
            elements.modalAbmeldungTime = document.getElementById('modalAbmeldungTime');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', cacheElements);

        // ============================================
        // START SCREEN FUNCTIONS
        // ============================================
        function openAnmeldung() {
            elements.startScreen.classList.add('hidden');
            elements.mainContent.classList.add('active');
            showTab('anmeldung');

            // Auto-fill fecha y hora en campos separados
            const now = new Date();
            const fecha = now.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const hora = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            elements.eingangDate.value = fecha;
            elements.eingangTime.value = hora;

            initSignatureCanvas();
        }

        function openAbmeldung() {
            elements.startScreen.classList.add('hidden');
            elements.mainContent.classList.add('active');
            showTab('abmeldung');
            loadPendingVisitors();
        }

        function goBack() {
            elements.startScreen.classList.remove('hidden');
            elements.mainContent.classList.remove('active');
            resetAnmeldungForm();
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        function showTab(tabId) {
            // Update tab buttons
            elements.tabAnmeldung.classList.remove('active');
            elements.tabAbmeldung.classList.remove('active');

            // Update tab content
            elements.anmeldung.classList.remove('active');
            elements.abmeldung.classList.remove('active');

            if (tabId === 'anmeldung') {
                elements.anmeldung.classList.add('active');
                elements.tabAnmeldung.classList.add('active');
                // Auto-fill when switching to Anmeldung
                if (!elements.eingangDate.value) {
                    const now = new Date();
                    const fecha = now.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const hora = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    elements.eingangDate.value = fecha;
                    elements.eingangTime.value = hora;
                }
                initSignatureCanvas();
            } else if (tabId === 'abmeldung') {
                elements.abmeldung.classList.add('active');
                elements.tabAbmeldung.classList.add('active');
                loadPendingVisitors();
            }
        }

        // ============================================
        // TIME FUNCTIONS
        // ============================================
        function getCurrentTime() {
            return new Date().toLocaleTimeString('de-DE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function setEingang() {
            document.getElementById('zeitKommen').value = getCurrentTime();
        }

        function setAusgang() {
            document.getElementById('zeitGehen').value = getCurrentTime();
            document.getElementById('confirmBtn').disabled = false;
        }

        // ============================================
        // MODAL
        // ============================================
        function showSuccessModal(nr, time) {
            elements.modalNr.textContent = nr;
            elements.modalTime.textContent = time;
            elements.successModal.classList.add('active');
        }

        function closeModal() {
            elements.successModal.classList.remove('active');
            goBack();
        }

        // ============================================
        // SIGNATURE CANVAS
        // ============================================
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let hasSignature = false;
        let canvasInitialized = false;
        let pendingX = 0;
        let pendingY = 0;
        let rafPending = false;

        function resizeCanvas() {
            if (!canvas) return;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        // Debounced resize handler
        const debouncedResize = debounce(resizeCanvas, 150);

        function initSignatureCanvas() {
            canvas = elements.signatureCanvas;
            if (!canvas) return;
            ctx = canvas.getContext('2d');

            resizeCanvas();

            // Only add event listeners once
            if (!canvasInitialized) {
                window.addEventListener('resize', debouncedResize);

                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);

                canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
                canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
                canvas.addEventListener('touchend', stopDrawing);

                canvasInitialized = true;
            }
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function getTouchPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getMousePos(e);
            lastX = pos.x;
            lastY = pos.y;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            isDrawing = true;
            const pos = getTouchPos(e);
            lastX = pos.x;
            lastY = pos.y;
        }

        // Throttled drawing using requestAnimationFrame
        function draw(e) {
            if (!isDrawing) return;
            const pos = getMousePos(e);
            pendingX = pos.x;
            pendingY = pos.y;
            scheduleDrawLine();
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const pos = getTouchPos(e);
            pendingX = pos.x;
            pendingY = pos.y;
            scheduleDrawLine();
        }

        function scheduleDrawLine() {
            if (rafPending) return;
            rafPending = true;
            requestAnimationFrame(() => {
                drawLine(pendingX, pendingY);
                rafPending = false;
            });
        }

        function drawLine(x, y) {
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            lastX = x;
            lastY = y;
            if (!hasSignature) {
                hasSignature = true;
                debouncedValidateForm();
            }
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearSignature() {
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            hasSignature = false;
            debouncedValidateForm();
        }

        function getSignatureData() {
            if (!hasSignature) return '';
            return canvas.toDataURL('image/png');
        }

        // ============================================
        // ANMELDUNG FORM
        // ============================================
        document.getElementById('anmeldungForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!document.getElementById('eingangDate').value || !document.getElementById('eingangTime').value) {
                alert('Fehler: Eingangszeit nicht erfasst.');
                return;
            }

            if (!hasSignature) {
                alert('Bitte unterschreiben Sie im Unterschriftsfeld.');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Wird gespeichert...';

            const nr = document.getElementById('nr').value;
            const name = document.getElementById('name').value;
            const eingangTime = document.getElementById('eingangTime').value;
            const eingang = document.getElementById('eingangDate').value + ' | ' + eingangTime;

            const formData = {
                action: 'anmeldung',
                nr: nr,
                name: name,
                firma: document.getElementById('firma').value,
                eingang: eingang,
                unterschrift: getSignatureData()
            };

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                document.getElementById('errorMessage').style.display = 'none';
                showSuccessModal(nr, eingangTime);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorMessage').style.display = 'block';
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Anmeldung speichern';
        });

        function validateForm() {
            const name = elements.name ? elements.name.value.trim() : '';
            const nr = elements.nr ? elements.nr.value.trim() : '';
            const checkbox = elements.bestaetigung ? elements.bestaetigung.checked : false;

            const isValid = name !== '' && nr !== '' && hasSignature && checkbox;
            if (elements.submitBtn) {
                elements.submitBtn.disabled = !isValid;
            }
        }

        // Initialize debounced version
        debouncedValidateForm = debounce(validateForm, 100);

        function resetAnmeldungForm() {
            document.getElementById('anmeldungForm').reset();
            document.getElementById('eingangDate').value = '';
            document.getElementById('eingangTime').value = '';
            clearSignature();
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('submitBtn').disabled = true;
        }

        // ============================================
        // ABMELDUNG - LOAD PENDING
        // ============================================
        async function loadPendingVisitors() {
            const container = document.getElementById('pendingVisitorsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Laden...</div>';
            
            document.getElementById('selectedVisitorDetails').classList.remove('active');
            selectedVisitor = null;

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getPending');
                const data = await response.json();
                
                pendingVisitors = data.visitors || [];
                renderPendingVisitors();

            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = '<div class="no-visitors">Fehler beim Laden. Bitte aktualisieren.</div>';
            }
        }

        // Helper to format date/time from various formats
        function formatVisitorDateTime(datum, zeit) {
            let dateStr = '';
            let timeStr = '';

            // Format date (datum)
            if (datum) {
                if (typeof datum === 'string' && datum.includes('.')) {
                    // Already in DD.MM.YYYY format
                    dateStr = datum;
                } else if (typeof datum === 'string' && datum.includes('T')) {
                    // ISO format
                    const d = new Date(datum);
                    dateStr = d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });
                } else {
                    dateStr = String(datum);
                }
            }

            // Format time (zeitKommen)
            if (zeit) {
                if (typeof zeit === 'string' && zeit.includes('T')) {
                    // ISO format from Sheets (time stored as date)
                    const t = new Date(zeit);
                    timeStr = t.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                } else if (typeof zeit === 'string' && zeit.includes(':')) {
                    // Already HH:MM format
                    timeStr = zeit;
                } else {
                    timeStr = String(zeit);
                }
            }

            return { date: dateStr, time: timeStr };
        }

        function renderPendingVisitors() {
            const container = document.getElementById('pendingVisitorsContainer');

            if (pendingVisitors.length === 0) {
                container.innerHTML = '<div class="no-visitors">Keine Besucher ohne Abmeldung.</div>';
                return;
            }

            let html = '';
            pendingVisitors.forEach((visitor, index) => {
                const formatted = formatVisitorDateTime(visitor.datum, visitor.zeitKommen);
                html += `
                    <div class="visitor-card" onclick="selectVisitor(${index})">
                        <div class="visitor-card-content">
                            <div class="visitor-left">
                                <span class="visitor-nr">Nr. ${visitor.nr}</span>
                                <div class="visitor-name">${visitor.name}</div>
                                <div class="visitor-firma">${visitor.firma || '-'}</div>
                            </div>
                            <div class="visitor-right">
                                <span class="visitor-eingang-badge">Eingang info</span>
                                <div class="datum-uhr">
                                    <span>Datum: <strong>${formatted.date}</strong></span>
                                    <span>Uhr: <strong>${formatted.time}</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function selectVisitor(index) {
            selectedVisitor = pendingVisitors[index];

            // Debug: ver estructura del objeto visitor
            console.log('Selected visitor object:', selectedVisitor);

            document.querySelectorAll('.visitor-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });

            document.getElementById('selectedVisitorDetails').classList.add('active');
            document.getElementById('abmeldungError').style.display = 'none';
        }

        // ============================================
        // ABMELDUNG - CONFIRM
        // ============================================
        async function confirmAbmeldung() {
            if (!selectedVisitor) return;

            const zeitGehen = getCurrentTime();

            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Wird gespeichert...';

            const formData = {
                action: 'abmeldung',
                row: selectedVisitor.row,
                zeitGehen: zeitGehen
            };

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                document.getElementById('abmeldungError').style.display = 'none';
                showAbmeldungModal(selectedVisitor.nr, zeitGehen);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('abmeldungError').style.display = 'block';
            }

            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Abmeldung';
        }

        function showAbmeldungModal(nr, time) {
            document.getElementById('modalAbmeldungNr').textContent = nr;
            document.getElementById('modalAbmeldungTime').textContent = time;
            document.getElementById('abmeldungModal').classList.add('active');
        }

        function closeAbmeldungModal() {
            document.getElementById('abmeldungModal').classList.remove('active');
            goBack();
        }
    </script>
</body>
</html>
